# PDF 匯出功能更新說明

## 更新摘要

已修改 PDF 匯出功能，現在**所有班表內容都會自動縮放並壓縮在一頁 A4 內**，不再分頁。

---

## 主要改進

### 1. 智慧縮放演算法 🎯

**修改前：**
- 只根據頁面寬度計算縮放比例
- 如果內容過長，會分成多頁

**修改後：**
```javascript
// 同時考慮寬度和高度
const scaleWidth = availableWidth / imgWidth;
const scaleHeight = availableHeight / imgHeight;

// 選擇較小的縮放比例，確保兩個維度都適合
const scale = Math.min(scaleWidth, scaleHeight);
```

現在會：
- ✅ 同時計算寬度和高度的縮放比例
- ✅ 選擇較小的比例，確保整個內容都適合
- ✅ 自動調整，不論有幾週的班表

### 2. 更緊湊的排版 📄

調整了 PDF 導出時的樣式，使內容更緊湊：

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| **標題字體** | 16px | 14px |
| **表格字體** | 12px | 10px |
| **表頭字體** | 12px | 11px |
| **儲存格間距** | 8px | 4px |
| **容器 padding** | 20px | 10px |
| **班表間距** | 16px | 8px |

### 3. 內容置中顯示 🎨

```javascript
// 將圖片水平和垂直置中
const xPosition = (pdfPageWidth - pdfImageWidth) / 2;
const yPosition = (pdfPageHeight - pdfImageHeight) / 2;
```

PDF 內容會在 A4 頁面上居中顯示，看起來更專業。

### 4. 移除分頁邏輯 🗑️

完全移除了原本的分頁程式碼：
```javascript
// ❌ 已刪除
while (heightLeft > 0) {
    position -= (pdfPageHeight - (margin * 2));
    pdf.addPage();
    // ...
}
```

現在保證只輸出一頁 PDF。

### 5. 改善錯誤處理 ⚠️

新增用戶友善的錯誤提示：
```javascript
catch (err) {
    console.error("html2canvas failed:", err);
    alert('PDF 導出失敗，請稍後再試');
    // 清理資源
}
```

---

## 技術細節

### 縮放邏輯說明

```javascript
// A4 尺寸：210mm × 297mm
const pdfPageWidth = 210;  // mm
const pdfPageHeight = 297; // mm
const margin = 10;         // mm

// 可用空間
const availableWidth = 210 - 20 = 190mm;
const availableHeight = 297 - 20 = 277mm;

// 計算縮放
假設原圖：1000px × 1500px

scaleWidth = 190 / 1000 = 0.19
scaleHeight = 277 / 1500 = 0.185

// 選擇較小的
scale = Math.min(0.19, 0.185) = 0.185

// 最終尺寸
width = 1000 × 0.185 = 185mm  ✅ 適合
height = 1500 × 0.185 = 277.5mm ✅ 適合
```

### 清晰度保證

```javascript
const canvas = await html2canvas(container, {
    scale: 2,  // 2倍解析度，確保清晰
    useCORS: true,
    allowTaint: true,
    backgroundColor: '#ffffff'
});
```

使用 `scale: 2` 確保即使縮放後，文字和表格仍然清晰可讀。

---

## 使用方式

### 導出單週班表
1. 設定週次為 `1`
2. 產生班表
3. 點擊 **PDF** 按鈕
4. 結果：一頁 A4，內容較大且清晰

### 導出多週班表
1. 設定週次為 `4`（或任意數字）
2. 產生班表
3. 點擊 **PDF** 按鈕
4. 結果：一頁 A4，內容自動縮小以容納所有週次

---

## 測試案例

### 測試 1: 單週班表
- **輸入**: 1 週
- **預期**: 內容較大，清晰可讀，置中顯示
- **狀態**: ✅ 通過

### 測試 2: 雙週班表
- **輸入**: 2 週
- **預期**: 兩週班表在一頁內，字體稍小
- **狀態**: ✅ 通過

### 測試 3: 四週班表
- **輸入**: 4 週
- **預期**: 四週班表壓縮在一頁內，仍可閱讀
- **狀態**: ✅ 通過

### 測試 4: 極端案例（10週）
- **輸入**: 10 週
- **預期**: 所有內容在一頁內，可能較小但仍可識別
- **狀態**: ⚠️ 建議週數不超過 6 週以保持可讀性

---

## 建議的使用方式

### 最佳實踐

1. **1-2 週班表** 📊
   - 內容大小適中
   - 清晰度最佳
   - 適合列印和數位查看

2. **3-4 週班表** 📋
   - 內容稍微縮小
   - 仍然清晰可讀
   - 適合月度排班

3. **5-6 週班表** 📅
   - 內容較小
   - 建議使用較大螢幕查看
   - 列印時建議使用高品質設定

4. **超過 6 週** ⚠️
   - 不建議使用 PDF 導出
   - 改用 **Excel 匯出**會更合適
   - 或分批導出（例如每 4 週一個 PDF）

---

## 與其他匯出格式的比較

| 格式 | 優點 | 缺點 | 適用場景 |
|------|------|------|----------|
| **PDF** | ✅ 單頁呈現<br>✅ 易於分享<br>✅ 專業外觀 | ❌ 多週時字體較小<br>❌ 無法編輯 | 1-4 週班表<br>正式文件 |
| **Excel** | ✅ 可編輯<br>✅ 清晰度不受影響<br>✅ 支援多工作表 | ❌ 需要 Excel 軟體 | 多週班表<br>需要編輯的情況 |
| **複製** | ✅ 快速<br>✅ 可貼到任何應用 | ❌ 格式可能跑掉 | 快速分享<br>即時溝通 |

---

## 已知限制

### 1. 週數過多時的可讀性
- **問題**: 超過 6 週時，字體會變得很小
- **解決方案**:
  - 使用 Excel 匯出
  - 分批導出 PDF（每 4 週一批）
  - 使用橫向 A4（未來功能）

### 2. 複雜班表的顯示
- **問題**: 如果單一勤務人數很多，表格會很高
- **解決方案**:
  - 簡化勤務設定
  - 減少每個勤務的人數
  - 分開處理不同勤務類型

### 3. 瀏覽器相容性
- **支援**: Chrome, Edge, Firefox, Safari
- **已知問題**: IE 不支援

---

## 未來改進建議

### 可能的功能增強

1. **橫向 A4 選項** 📄
   ```javascript
   const pdf = new jsPDF('l', 'mm', 'a4'); // landscape
   ```
   - 可容納更寬的表格
   - 適合勤務種類較多的情況

2. **自訂字體大小** 🔤
   - 讓用戶選擇 PDF 的字體大小
   - 在清晰度和內容量之間取捨

3. **分頁選項** 📑
   - 提供「單頁模式」和「多頁模式」切換
   - 單頁：目前的行為
   - 多頁：每週一頁，字體較大

4. **智慧分組** 🧩
   - 自動偵測內容量
   - 建議最佳的週數分組
   - 例如：「建議每 3 週導出一次 PDF」

---

## 技術架構

### 依賴的函式庫

1. **html2canvas 1.4.1**
   - 將 HTML 轉換為 Canvas
   - 支援複雜的 CSS 樣式

2. **jsPDF 2.5.1**
   - 生成 PDF 檔案
   - 支援圖片嵌入和多頁

### 執行流程

```
1. 用戶點擊 PDF 按鈕
   ↓
2. 複製所有班表 DOM 元素
   ↓
3. 套用緊湊的 CSS 樣式
   ↓
4. 使用 html2canvas 渲染為圖片 (scale: 2)
   ↓
5. 計算最佳縮放比例 (考慮寬高)
   ↓
6. 創建 A4 PDF 並置中放入圖片
   ↓
7. 下載 "班表.pdf"
   ↓
8. 清理臨時元素和樣式
```

---

## 常見問題 FAQ

### Q1: 為什麼 4 週以上的 PDF 字很小？

**A:** 因為所有內容都壓縮在一頁 A4 內。建議：
- 使用 Excel 匯出（可多工作表，清晰度不受影響）
- 分批導出（例如 1-4 週一個 PDF，5-8 週另一個）
- 未來可能新增橫向 A4 選項

### Q2: 可以調整 PDF 的字體大小嗎？

**A:** 目前是自動計算最佳大小。如需固定大小，建議：
- 使用 Excel 匯出後自行調整
- 或在瀏覽器中放大班表後截圖

### Q3: PDF 導出失敗怎麼辦？

**A:** 可能原因和解決方法：
1. **瀏覽器記憶體不足**: 減少週數，關閉其他分頁
2. **彈出視窗被封鎖**: 允許下載
3. **班表內容過大**: 嘗試減少勤務或人員數量

### Q4: PDF 的清晰度夠嗎？

**A:** 使用 `scale: 2` 確保清晰度。如果：
- **螢幕閱讀**: 絕對足夠
- **列印**: 建議 1-4 週的班表，超過 4 週建議用 Excel

### Q5: 可以改成橫向 A4 嗎？

**A:** 目前是直向。如需橫向，請在 GitHub Issues 提出需求，或參考上方「未來改進建議」自行修改。

---

## 版本歷史

### v2.0 (目前版本)
- ✅ 單頁 A4 自動縮放
- ✅ 智慧計算寬高比例
- ✅ 內容垂直和水平置中
- ✅ 更緊湊的排版樣式
- ✅ 改善錯誤處理

### v1.0 (原始版本)
- 支援 PDF 導出
- 自動分頁（多頁）
- 固定樣式

---

## 總結

現在 PDF 匯出功能已優化，**無論產生幾週的班表，都會智慧縮放並壓縮在一頁 A4 內**。

**最佳使用場景：**
- ✅ 1-4 週的班表 → 使用 PDF
- ✅ 超過 4 週 → 建議使用 Excel 匯出

**核心改進：**
1. 雙維度縮放計算（寬度 + 高度）
2. 更緊湊的排版樣式
3. 內容自動置中
4. 保證單頁輸出

立即測試新功能，享受更便捷的 PDF 匯出體驗！📄
