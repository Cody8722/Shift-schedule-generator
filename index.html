<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班表產生器 (雲端資料庫版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- 新增 PDF 產生工具 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: '標楷體', 'BiauKai', 'DFKai-SB', 'Noto Sans TC', sans-serif; 
            color: #000000;
        }
        
        /* -- 列印專用樣式 -- */
        @media print {
            @page {
                size: A4 portrait;
            }
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            .no-print { display: none !important; }
            body, html {
                margin: 0 !important; padding: 0 !important;
                background: #fff !important;
            }
            .container {
                padding: 0.5cm !important; width: 100% !important; max-width: 100% !important;
                box-shadow: none !important; border: none !important;
            }
            main { display: block !important; }
            #main-results-column { width: 100% !important; padding: 0 !important; margin: 0 !important; }
            #stats-output-wrapper, #saved-schedules-area { display: none !important; }
            
            #schedule-output {
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                height: 100%;
            }
            #schedule-output .weekly-schedule {
                border: 1px solid #ccc;
                padding: 2mm;
                margin: 0 0 0.5cm 0;
                page-break-inside: avoid;
                overflow: hidden;
            }
            #schedule-output h2 {
                font-size: 10pt !important;
                margin-bottom: 4px !important;
                font-weight: bold;
            }
            #schedule-output table {
                width: 100%;
                border-collapse: collapse;
            }
            #schedule-output table th, 
            #schedule-output table td {
                padding: 1px 2px !important;
                font-size: 7pt !important;
                border: 1px solid #333 !important; 
                white-space: normal !important; 
                text-align: center;
                vertical-align: middle;
            }
            #schedule-output table th { font-weight: bold; }
        }

        #schedule-output table td {
            white-space: pre-wrap;
            vertical-align: middle;
        }
    </style>
</head>
<body class="bg-gray-50 text-black">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 no-print">
            <h1 class="text-3xl md:text-4xl font-bold" style="color: #4c51bf;">班表產生器 (雲端資料庫版)</h1>
            <p class="text-gray-500 mt-2">所有設定與班表將永久儲存在雲端資料庫</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg-col-span-1 bg-white p-6 rounded-2xl shadow-lg no-print space-y-4">
                <!-- Profile Management -->
                <div class="p-3 border rounded-lg bg-gray-50 space-y-3">
                    <label for="profile-selector" class="text-sm font-bold text-gray-700">設定檔管理</label>
                    <select id="profile-selector" class="w-full p-2 border rounded-md shadow-sm text-black"></select>
                    <div class="grid grid-cols-3 gap-2">
                        <button id="new-profile-btn" class="text-sm bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">新增</button>
                        <button id="rename-profile-btn" class="text-sm bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600">重新命名</button>
                        <button id="delete-profile-btn" class="text-sm bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">刪除</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="text-sm font-medium text-gray-700">開始日期</label>
                        <input type="date" id="start-date" class="mt-1 w-full p-2 border rounded-md shadow-sm text-black">
                    </div>
                    <div>
                        <label for="num-weeks" class="text-sm font-medium text-gray-700">產生週數</label>
                        <select id="num-weeks" class="mt-1 w-full p-2 border rounded-md shadow-sm text-black">
                            <option value="1">1 週</option>
                            <option value="2">2 週</option>
                            <option value="3">3 週</option>
                            <option value="4">4 週</option>
                        </select>
                    </div>
                </div>

                <div class="mt-2 flex items-center space-x-2">
                    <input type="checkbox" id="skip-holidays" class="form-checkbox h-5 w-5 text-purple-600 rounded" checked>
                    <label for="skip-holidays" class="text-sm font-medium text-gray-700">自動跳過國定假日 (台灣)</label>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="tasks" class="text-sm font-medium text-gray-700">勤務地點／任務</label>
                        <div class="flex space-x-2">
                            <button class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-md save-template-btn" data-type="tasks">儲存列表</button>
                            <button class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-md load-template-btn" data-type="tasks">讀取列表</button>
                        </div>
                    </div>
                    <textarea id="tasks" rows="4" class="mt-1 w-full p-2 border rounded-md shadow-sm text-black" placeholder="素描教室:2&#10;大鏡子:1"></textarea>
                </div>
                <div>
                     <div class="flex justify-between items-center mb-1">
                        <label for="names" class="text-sm font-medium text-gray-700">人員名單</label>
                        <div class="flex space-x-2">
                            <button class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-md save-template-btn" data-type="names">儲存列表</button>
                            <button class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-md load-template-btn" data-type="names">讀取列表</button>
                        </div>
                    </div>
                    <textarea id="names" rows="5" class="mt-1 w-full p-2 border rounded-md shadow-sm text-black" placeholder="葉郁雅&#10;陳祈瑋:2"></textarea>
                </div>
                 <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="preferences" class="text-sm font-medium text-gray-700">偏好位置 (選填)</label>
                        <div class="flex space-x-2">
                            <button class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-md save-template-btn" data-type="preferences">儲存列表</button>
                            <button class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-md load-template-btn" data-type="preferences">讀取列表</button>
                        </div>
                    </div>
                    <textarea id="preferences" rows="3" class="mt-1 w-full p-2 border rounded-md shadow-sm text-black" placeholder="葉郁雅:素描教室"></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="unavailability" class="text-sm font-medium text-gray-700">不能值勤時間 (選填)</label>
                        <div class="flex space-x-2">
                            <button class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-md save-template-btn" data-type="unavailability">儲存列表</button>
                            <button class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-md load-template-btn" data-type="unavailability">讀取列表</button>
                        </div>
                    </div>
                    <textarea id="unavailability" rows="3" class="mt-1 w-full p-2 border rounded-md shadow-sm text-black" placeholder="陳祈瑋:一,三"></textarea>
                </div>
                 <div>
                    <label for="max-shifts" class="text-sm font-medium text-gray-700">預設每週最多值勤次數</label>
                    <input type="number" id="max-shifts" value="3" min="1" class="mt-1 w-full p-2 border rounded-md shadow-sm text-black">
                </div>
                 <div class="space-y-3 pt-2">
                    <button id="generate-btn" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 shadow-md">產生並儲存設定</button>
                    <button id="save-schedule-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 shadow-md disabled:bg-gray-300" disabled>儲存產生結果</button>
                    <button id="export-excel-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 shadow-md disabled:bg-gray-300" disabled>匯出成 Excel (.xlsx)</button>
                    <div class="grid grid-cols-3 gap-3">
                         <button id="print-btn" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">列印</button>
                         <button id="download-pdf-btn" class="w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-800 disabled:bg-gray-300" disabled>下載 PDF</button>
                         <button id="copy-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-300" disabled>複製</button>
                    </div>
                    <hr>
                    <div class="grid grid-cols-2 gap-3">
                        <label for="import-file-input" class="w-full text-center bg-teal-500 text-white py-2 rounded-lg hover:bg-teal-600 cursor-pointer">匯入設定檔</label>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                        <button id="export-settings-btn" class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600">匯出所選設定</button>
                    </div>
                </div>
            </div>

            <div id="main-results-column" class="lg:col-span-2 space-y-6">
                <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg min-h-[400px]">
                     <div id="placeholder" class="flex flex-col items-center justify-center h-full text-gray-400">
                        <p class="text-lg">產生的班表將會顯示在這裡</p>
                    </div>
                    <div id="schedule-output"></div>
                </div>
                <div id="output-area-extra">
                    <div id="stats-output-wrapper" class="space-y-6"></div>
                    <div id="warnings-output-wrapper" class="space-y-6 mt-6"></div>
                </div>
                <div id="saved-schedules-area" class="no-print">
                    <!-- This will be populated by JS -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for loading templates -->
    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold">讀取列表</h3>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="p-4 max-h-64 overflow-y-auto">
                <!-- Template list will be injected here -->
            </div>
        </div>
    </div>

    <!-- Modal for Exporting Settings -->
    <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="export-modal-title" class="text-lg font-bold">選擇要匯出的項目</h3>
                <button id="export-modal-close-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="export-modal-body" class="p-6 space-y-4">
                <p class="text-sm text-gray-600">請勾選您想要包含在匯出檔案中的設定項目。</p>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100">
                        <input type="checkbox" id="export-tasks" class="form-checkbox h-5 w-5 text-purple-600" checked>
                        <span>勤務地點／任務</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100">
                        <input type="checkbox" id="export-names" class="form-checkbox h-5 w-5 text-purple-600" checked>
                        <span>人員名單</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100">
                        <input type="checkbox" id="export-preferences" class="form-checkbox h-5 w-5 text-purple-600" checked>
                        <span>偏好位置</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100">
                        <input type="checkbox" id="export-unavailability" class="form-checkbox h-5 w-5 text-purple-600" checked>
                        <span>不能值勤時間</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100">
                        <input type="checkbox" id="export-maxShifts" class="form-checkbox h-5 w-5 text-purple-600" checked>
                        <span>預設值勤次數</span>
                    </label>
                     <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100">
                        <input type="checkbox" id="export-dates" class="form-checkbox h-5 w-5 text-purple-600" checked>
                        <span>日期與週數</span>
                    </label>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end space-x-3">
                <button id="export-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">取消</button>
                <button id="export-modal-confirm-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">確認匯出</button>
            </div>
        </div>
    </div>


<script>
// --- Global Scope Functions for Inline Event Handlers ---
window.loadSchedule = async (name) => {
    const API_BASE_URL = window.location.origin;
    try {
        const res = await fetch(`${API_BASE_URL}/api/schedules/${encodeURIComponent(name)}`);
        if (!res.ok) throw new Error('無法載入班表');
        const loadedData = await res.json();
        document.dispatchEvent(new CustomEvent('renderSchedule', { detail: loadedData }));
        alert(`已成功載入班表 "${name}"！`);
    } catch(error) {
        console.error("載入班表失敗:", error);
        alert(`載入班表 "${name}" 失敗。`);
    }
};

window.deleteSchedule = async (name) => {
    const API_BASE_URL = window.location.origin;
    if (!confirm(`您確定要刪除已儲存的班表 "${name}" 嗎？`)) return;
    try {
        const res = await fetch(`${API_BASE_URL}/api/schedules/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('無法刪除班表');
        document.dispatchEvent(new Event('refreshData'));
    } catch(error) {
        console.error("刪除班表失敗:", error);
        alert(`刪除班表 "${name}" 失敗。`);
    }
};


document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Element Selection ---
    const allInputs = {
        startDate: document.getElementById('start-date'),
        numWeeks: document.getElementById('num-weeks'),
        tasks: document.getElementById('tasks'),
        names: document.getElementById('names'),
        maxShifts: document.getElementById('max-shifts'),
        unavailability: document.getElementById('unavailability'),
        preferences: document.getElementById('preferences'),
        skipHolidays: document.getElementById('skip-holidays'),
    };
    const profileSelector = document.getElementById('profile-selector');
    const newProfileBtn = document.getElementById('new-profile-btn');
    const renameProfileBtn = document.getElementById('rename-profile-btn');
    const deleteProfileBtn = document.getElementById('delete-profile-btn');
    const generateBtn = document.getElementById('generate-btn');
    const saveScheduleBtn = document.getElementById('save-schedule-btn');
    const printBtn = document.getElementById('print-btn');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');
    const copyBtn = document.getElementById('copy-btn');
    const exportExcelBtn = document.getElementById('export-excel-btn');
    const exportSettingsBtn = document.getElementById('export-settings-btn');
    const importFileInput = document.getElementById('import-file-input');
    const scheduleOutput = document.getElementById('schedule-output');
    const statsOutputWrapper = document.getElementById('stats-output-wrapper');
    const warningsOutputWrapper = document.getElementById('warnings-output-wrapper');
    const placeholder = document.getElementById('placeholder');
    const savedSchedulesArea = document.getElementById('saved-schedules-area');
    // Modals
    const templateModal = document.getElementById('template-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const exportModal = document.getElementById('export-modal');
    const exportModalCloseBtn = document.getElementById('export-modal-close-btn');
    const exportModalCancelBtn = document.getElementById('export-modal-cancel-btn');
    const exportModalConfirmBtn = document.getElementById('export-modal-confirm-btn');
    
    // --- State Variables ---
    let generatedData = null;
    let loadingMessageIndex = 0;
    const API_BASE_URL = window.location.origin;
    const TEMPLATE_STORAGE_KEY = 'scheduleListTemplates';
    const loadingMessages = [
        "伺服器正在努力連接 >_<",
        "請再稍等一下，馬上就好！",
        "正在呼叫雲端資料庫，請稍等它起床...",
        "伺服器正在加速衝刺，終點線就在前方！",
        "系統正在喝杯咖啡提神，馬上回來！",
        "正在為您鋪設通往雲端的專線...",
        "資料庫管理員正在尋找鑰匙...找到了！",
        "系統正在進行深度睡眠喚醒程序...",
        "請稍候，伺服器正在做暖身操...",
        "排班引擎預熱中，請繫好安全帶！",
        "我們正在確認所有資料都安然無恙...",
        "就快好了，我保證！(希望啦...)",
        "您的耐心值得等待，完美的班表即將呈現！",
        "正在與全球網路進行友好協商..."
    ];

    const colorSchemes = [
        { header: 'cc4125', name: 'e6b8af' }, { header: 'e06666', name: 'f4cccc' },
        { header: 'f6b26b', name: 'fce5cd' }, { header: 'ffd966', name: 'fff2cc' },
        { header: '93c47d', name: 'd9ead3' }, { header: '76a5af', name: 'd0e0e3' },
        { header: '6d9eeb', name: 'c9daf8' }, { header: '6fa8dc', name: 'cfe2f3' },
        { header: '8e7cc3', name: 'd9d2e9' }, { header: 'c27ba0', name: 'ead1dc' }
    ];

    // --- Data Management ---
    async function initApp() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/data`);

            if (response.status === 503) {
                const message = loadingMessages[loadingMessageIndex % loadingMessages.length];
                placeholder.innerHTML = `<p class="text-lg text-blue-500">${message}</p>`;
                loadingMessageIndex++;
                setTimeout(initApp, 3000);
                return;
            }

            if (!response.ok) {
                 placeholder.innerHTML = `<p class="text-lg text-red-500">無法從伺服器取得資料，請重新整理頁面。</p>`;
                 throw new Error('無法從伺服器取得資料');
            }
            
            const db = await response.json();
            const profiles = Object.keys(db.profiles);
            const activeProfileName = db.activeProfile;

            profileSelector.innerHTML = '';
            profiles.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                profileSelector.appendChild(option);
            });
            
            profileSelector.value = activeProfileName;
            
            const activeProfile = db.profiles[activeProfileName];
            if (activeProfile) {
                updateUIFromSettings(activeProfile.settings);
                loadSavedSchedules(activeProfile.schedules || {});
            }
            if (!activeProfile?.settings?.startDate) {
                setDefaultDate();
            }
        } catch (error) {
            console.error("初始化 App 失敗:", error);
        }
    }

    async function handleProfileChange() {
        const newProfileName = profileSelector.value;
        try {
            await fetch(`${API_BASE_URL}/api/active_profile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newProfileName })
            });
            await initApp();
        } catch (error) {
            console.error("切換設定檔失敗:", error);
            alert("切換設定檔失敗。");
        }
    }

    async function saveCurrentSettingsToServer() {
        const settings = {
            startDate: allInputs.startDate.value,
            numWeeks: allInputs.numWeeks.value,
            tasks: allInputs.tasks.value,
            names: allInputs.names.value,
            defaultMaxShifts: allInputs.maxShifts.value,
            unavailability: allInputs.unavailability.value,
            preferences: allInputs.preferences.value
        };
        try {
            const response = await fetch(`${API_BASE_URL}/api/settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: '無法解析伺服器錯誤訊息' }));
                throw new Error(`伺服器回應錯誤: ${response.status} - ${errorData.message}`);
            }
            return true;
        } catch (error) {
            console.error("儲存設定失敗的詳細錯誤:", error);
            alert(`儲存設定到伺服器失敗！\n錯誤訊息: ${error.message}`);
            return false;
        }
    }

    function updateUIFromSettings(settings) {
        if (!settings) return;
        allInputs.startDate.value = settings.startDate || '';
        allInputs.numWeeks.value = settings.numWeeks || '1';
        allInputs.tasks.value = settings.tasks || '';
        allInputs.names.value = settings.names || '';
        allInputs.maxShifts.value = settings.defaultMaxShifts || '3';
        allInputs.unavailability.value = settings.unavailability || '';
        allInputs.preferences.value = settings.preferences || '';
    }

    function setDefaultDate() {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(today.setDate(diff));
        allInputs.startDate.value = monday.toISOString().split('T')[0];
    }
    
    function loadSavedSchedules(schedules) {
        savedSchedulesArea.innerHTML = '';
        const scheduleNames = Object.keys(schedules);
        
        const container = document.createElement('div');
        container.className = 'bg-white p-6 rounded-2xl shadow-lg';

        let content;
        if (scheduleNames.length === 0) {
            content = '<p class="text-gray-500 text-center">目前沒有已儲存的班表。</p>';
        } else {
            const listItems = scheduleNames.map(name => `
                <li class="flex justify-between items-center p-2 border-b">
                    <span class="truncate pr-4">${name}</span>
                    <div class="flex-shrink-0">
                        <button onclick="loadSchedule('${name.replace(/'/g, "\\'")}')" class="text-sm bg-green-500 text-white py-1 px-3 rounded hover:bg-green-600">載入</button>
                        <button onclick="deleteSchedule('${name.replace(/'/g, "\\'")}')" class="text-sm bg-red-500 text-white py-1 px-3 rounded hover:bg-red-600 ml-2">刪除</button>
                    </div>
                </li>
            `).join('');
            content = `<h3 class="text-xl font-bold mb-4 text-center">已儲存的班表</h3><ul class="space-y-2">${listItems}</ul>`;
        }
        container.innerHTML = content;
        savedSchedulesArea.appendChild(container);
    }

    async function saveCurrentSchedule() {
        if (!generatedData || generatedData.length === 0) {
            alert("請先產生班表，才能儲存。");
            return;
        }
        const defaultName = `班表_${generatedData[0].dateRange.replace(/[/~]/g, '-')}`;
        const name = prompt("請為此班表命名：", defaultName);
        if (!name || !name.trim()) return;
        
        try {
            const res = await fetch(`${API_BASE_URL}/api/schedules`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name.trim(), data: generatedData })
            });
            if (!res.ok) throw new Error('無法儲存班表');
            
            alert(`班表 "${name.trim()}" 已成功儲存！`);
            await initApp();
        } catch (error) {
            console.error("儲存班表失敗:", error);
            alert("儲存班表失敗。");
        }
    }

    initApp();

    // --- Event Listeners ---
    document.addEventListener('refreshData', initApp);
    document.addEventListener('renderSchedule', (e) => {
        generatedData = e.detail;
        renderAllOutputs(e.detail, []); // Pass empty warnings for loaded schedules
    });

    profileSelector.addEventListener('change', handleProfileChange);
    newProfileBtn.addEventListener('click', async () => {
        const name = prompt("請輸入新的設定檔名稱:");
        if (name && name.trim()) {
            const res = await fetch(`${API_BASE_URL}/api/profiles`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name.trim() })
            });
            if (!res.ok) { alert('新增失敗，設定檔名稱可能已存在。'); return; }
            await initApp();
            profileSelector.value = name.trim();
        }
    });
    renameProfileBtn.addEventListener('click', async () => {
        const oldName = profileSelector.value;
        const newName = prompt("請輸入新的名稱:", oldName);
        if (newName && newName.trim() && newName.trim() !== oldName) {
            const res = await fetch(`${API_BASE_URL}/api/profiles/rename`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ oldName, newName: newName.trim() })
            });
            if (!res.ok) { alert('重新命名失敗，名稱可能已存在。'); return; }
            await initApp();
            profileSelector.value = newName.trim();
        }
    });
    deleteProfileBtn.addEventListener('click', async () => {
        const name = profileSelector.value;
        if (confirm(`您確定要刪除 "${name}" 這個設定檔嗎？所有相關設定與已存班表都會一併刪除！`)) {
            await fetch(`${API_BASE_URL}/api/profiles/delete`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            await initApp();
        }
    });

    generateBtn.addEventListener('click', generateAllSchedules);
    saveScheduleBtn.addEventListener('click', saveCurrentSchedule);
    printBtn.addEventListener('click', () => window.print());
    downloadPdfBtn.addEventListener('click', downloadPDF);
    copyBtn.addEventListener('click', copyToClipboard);
    exportExcelBtn.addEventListener('click', exportToExcel);
    exportSettingsBtn.addEventListener('click', openExportModal);
    importFileInput.addEventListener('change', importSettingsFromFile);
    
    // --- Core Logic ---
    async function fetchHolidays() {
        const holidayStatusMap = new Map();
        const url = `${API_BASE_URL}/api/holidays`; // Fetch from our own server
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP 錯誤！狀態: ${response.status}`);
            }
            const holidays = await response.json();
            
            holidays.forEach(day => {
                const year = day.date.substring(0, 4);
                const month = parseInt(day.date.substring(4, 6), 10);
                const date = parseInt(day.date.substring(6, 8), 10);
                const dateStr = `${year}/${month}/${date}`;
                holidayStatusMap.set(dateStr, { isHoliday: day.isHoliday, description: day.description });
            });

        } catch (error) {
            console.error("讀取國定假日失敗:", error);
            alert("無法從伺服器讀取國定假日資訊，將正常排班。");
        }
        return holidayStatusMap;
    }

    async function generateAllSchedules() {
        const saved = await saveCurrentSettingsToServer();
        if (!saved) return;
        
        let holidayStatusMap = new Map();
        if (allInputs.skipHolidays.checked) {
            holidayStatusMap = await fetchHolidays();
        }

        try {
            const numWeeks = parseInt(allInputs.numWeeks.value) || 1;
            const tasks = allInputs.tasks.value.split('\n').filter(line => line.trim() !== '').map(line => {
                const parts = line.split(':');
                return { name: parts[0].trim(), count: parts.length > 1 && !isNaN(parseInt(parts[1])) ? parseInt(parts[1].trim()) : 1 };
            });
            const defaultMaxShifts = parseInt(allInputs.maxShifts.value) || 99;
            const people = allInputs.names.value.split('\n').filter(n => n.trim() !== '').map(line => {
                const parts = line.split(':');
                return { name: parts[0].trim(), maxShifts: parts.length > 1 && !isNaN(parseInt(parts[1])) ? parseInt(parts[1].trim()) : defaultMaxShifts };
            });
            const dayMap = {'一':0, '二':1, '三':2, '四':3, '五':4, '六': 5, '日': 6}; // Include weekends for unavailabilities
            
            const unavailabilities = {};
            allInputs.unavailability.value.split('\n').filter(line => line.trim() !== '').forEach(line => {
                 const parts = line.split(':', 1);
                 if (parts.length === 1 && line.includes(':')) {
                    const name = line.substring(0, line.indexOf(':')).trim();
                    const days = line.substring(line.indexOf(':') + 1);
                     unavailabilities[name] = days.split(',').map(day => dayMap[day.trim()]).filter(d => d !== undefined);
                }
            });

            const preferences = {};
            allInputs.preferences.value.split('\n').filter(line => line.trim() !== '').forEach(line => {
                 const parts = line.split(':', 1);
                 if (parts.length === 1 && line.includes(':')) {
                     const name = line.substring(0, line.indexOf(':')).trim();
                    const tasks = line.substring(line.indexOf(':') + 1);
                    preferences[name] = tasks.split(',').map(task => task.trim());
                }
            });

            if (tasks.length === 0 || people.length === 0) {
                alert('請至少輸入一項任務和一個人員名稱。');
                return;
            }
            
            // --- Data Validation from suggestion ---
            const totalNeededPerDay = tasks.reduce((sum, task) => sum + task.count, 0);
            if (people.length < totalNeededPerDay) {
                scheduleOutput.innerHTML = '';
                statsOutputWrapper.innerHTML = '';
                warningsOutputWrapper.innerHTML = '';
                placeholder.innerHTML = `<div class="text-red-600 p-4 border border-red-400 rounded-lg bg-red-50">
                    <h3 class="font-bold">人員不足警告</h3>
                    <p>總人力 (${people.length}人) 少於每日所需的最少人力 (${totalNeededPerDay}人)，無法產生班表。請增加人員或減少勤務需求。</p>
                </div>`;
                placeholder.style.display = 'flex';
                return;
            }


            let userSelectedDate = new Date(allInputs.startDate.value);
            const dayOfWeek = userSelectedDate.getDay();
            const diffToMonday = userSelectedDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            let currentStartDate = new Date(userSelectedDate.setDate(diffToMonday));

            currentStartDate.setMinutes(currentStartDate.getMinutes() + currentStartDate.getTimezoneOffset());
            
            const scheduleData = [];
            const allWarnings = [];

            for (let i = 0; i < numWeeks; i++) {
                const weekDayDates = [];
                const scheduleDays = []; // Internal 7-day structure
                
                const tempDate = new Date(currentStartDate);
                for (let j = 0; j < 7; j++) { 
                    const dateStr = `${tempDate.getFullYear()}/${tempDate.getMonth() + 1}/${tempDate.getDate()}`;
                    const day = tempDate.getDay();
                    
                    const specialDayInfo = holidayStatusMap.get(dateStr);
                    const isSpecialDay = !!specialDayInfo;
                    const isHoliday = isSpecialDay && specialDayInfo.isHoliday;
                    const isWeekend = day === 0 || day === 6;

                    const shouldSchedule = !isWeekend && !isHoliday;
                    
                    scheduleDays.push({
                        date: new Date(tempDate),
                        shouldSchedule: shouldSchedule,
                        isHoliday: isHoliday,
                        description: isSpecialDay ? specialDayInfo.description : ""
                    });
                    
                    weekDayDates.push(`${tempDate.getMonth() + 1}/${tempDate.getDate()}`);
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                const weeklyData = generateSingleWeek(tasks, people, unavailabilities, preferences, scheduleDays);
                if (weeklyData.warnings.length > 0) {
                    allWarnings.push(...weeklyData.warnings.map(w => `第 ${i + 1} 週：${w}`));
                }
                const endDate = new Date(currentStartDate);
                endDate.setDate(currentStartDate.getDate() + 4); // Display range is still Mon-Fri
                const dateRange = `${currentStartDate.getMonth() + 1}/${currentStartDate.getDate()}~${endDate.getMonth() + 1}/${endDate.getDate()}`;
                
                scheduleData.push({ ...weeklyData, dateRange, tasks, people, weekDayDates, scheduleDays });
                currentStartDate.setDate(currentStartDate.getDate() + 7);
            }
            
            generatedData = scheduleData;
            setTimeout(() => renderAllOutputs(scheduleData, allWarnings), 0);
        } catch (error) {
            console.error("!!! 產生班表時發生前端錯誤:", error);
            alert("產生班表時發生錯誤，請檢查 F12 Console 的紅色訊息。");
        }
    }
    
    function generateSingleWeek(tasks, people, unavailabilities, preferences, scheduleDays) {
        const shiftCounts = Object.fromEntries(people.map(p => [p.name, 0]));
        const schedule = Array(7).fill(null).map(() => Array(tasks.length).fill(null).map(() => []));
        const dailyAssignments = Array(7).fill(null).map(() => []);
        const warnings = [];

        scheduleDays.forEach((day, dayIndex) => {
            if (!day.shouldSchedule) return;

            const dayOfWeek = day.date.getDay(); 
            const mappedDay = (dayOfWeek + 6) % 7; // Map Monday=0, ... Sunday=6

            for (let taskIndex = 0; taskIndex < tasks.length; taskIndex++) {
                const task = tasks[taskIndex];
                let eligibleCandidates = people.filter(p => 
                    !unavailabilities[p.name]?.includes(mappedDay) &&
                    shiftCounts[p.name] < p.maxShifts &&
                    !dailyAssignments[dayIndex].includes(p.name)
                );
                
                // --- Error Handling from suggestion ---
                if (eligibleCandidates.length < task.count) {
                    const dayName = ['一', '二', '三', '四', '五', '六', '日'][mappedDay];
                    warnings.push(`星期${dayName}的 "${task.name}" 勤務，需求 ${task.count} 人，但只有 ${eligibleCandidates.length} 位符合資格的人員，可能有人手不足的情況。`);
                }

                eligibleCandidates.sort((a, b) => {
                    const aPrefers = preferences[a.name]?.includes(task.name);
                    const bPrefers = preferences[b.name]?.includes(task.name);
                    if (aPrefers && !bPrefers) return -1;
                    if (!aPrefers && bPrefers) return 1;
                    if (shiftCounts[a.name] !== shiftCounts[b.name]) return shiftCounts[a.name] - shiftCounts[b.name];
                    return Math.random() - 0.5;
                });
                
                const assigned = eligibleCandidates.slice(0, task.count);
                assigned.forEach(person => {
                    schedule[dayIndex][taskIndex].push(person.name);
                    shiftCounts[person.name]++;
                    dailyAssignments[dayIndex].push(person.name);
                });
            }
        });
        return { schedule, shiftCounts, warnings };
    }

    function renderAllOutputs(allData, allWarnings) {
        if (!scheduleOutput || !statsOutputWrapper) return;
        
        if (placeholder) placeholder.style.display = 'none';
        scheduleOutput.innerHTML = '';
        statsOutputWrapper.innerHTML = '';
        warningsOutputWrapper.innerHTML = '';
        
        allData.forEach((data, index) => {
            if (!data.colorScheme) {
                data.colorScheme = colorSchemes[Math.floor(Math.random() * colorSchemes.length)];
            }
            
            const scheduleContainer = document.createElement('div');
            scheduleContainer.className = 'mb-8 weekly-schedule';
            const weekTitle = document.createElement('h2');
            weekTitle.className = 'text-xl font-bold mb-4 text-center';
            weekTitle.textContent = `第 ${index + 1} 週班表 (${data.dateRange})`;
            scheduleContainer.appendChild(weekTitle);
            scheduleContainer.appendChild(renderScheduleTable(data, data.colorScheme));
            scheduleOutput.appendChild(scheduleContainer);

            const statsContainer = document.createElement('div');
            statsContainer.id = `stats-output-${index}`;
            statsContainer.className = 'stats-container bg-white p-4 sm:p-6 rounded-2xl shadow-lg';
            statsContainer.innerHTML = renderStatistics(data, index);
            statsOutputWrapper.appendChild(statsContainer);
        });

        if (allWarnings && allWarnings.length > 0) {
            const warningsContainer = document.createElement('div');
            warningsContainer.className = 'warnings-container bg-yellow-50 border border-yellow-300 text-yellow-800 p-4 sm:p-6 rounded-2xl shadow-lg no-print';
            let warningsHTML = `<h3 class="text-lg font-bold mb-3 text-center">排班警告</h3><ul class="list-disc list-inside space-y-1">`;
            allWarnings.forEach(warning => {
                warningsHTML += `<li>${warning}</li>`;
            });
            warningsHTML += '</ul>';
            warningsContainer.innerHTML = warningsHTML;
            warningsOutputWrapper.appendChild(warningsContainer);
        }
        
        copyBtn.disabled = false;
        exportExcelBtn.disabled = false;
        saveScheduleBtn.disabled = false;
        downloadPdfBtn.disabled = false;
    }

    function renderScheduleTable({ schedule, tasks, weekDayDates, scheduleDays }, colorScheme) {
        const weekDayNames = ['一', '二', '三', '四', '五'];
        const table = document.createElement('table');
        table.className = 'w-full border-collapse text-center table-fixed';
        
        let tableHead = `<thead><tr><th class="p-2 border border-gray-300 text-left" style="background-color: #${colorScheme.header};">勤務地點</th>`;
        weekDayDates.slice(0, 5).forEach((date, index) => {
            const dayName = weekDayNames[index];
            tableHead += `<th class="p-2 border border-gray-300" style="background-color: #${colorScheme.header};">星期${dayName}<br>(${date})</th>`;
        });
        tableHead += `</tr></thead>`;
        
        let tableBody = '<tbody>';
        tasks.forEach((task, taskIndex) => {
            for (let i = 0; i < task.count; i++) {
                tableBody += `<tr>`;
                if (i === 0) {
                    tableBody += `<td class="p-2 border border-gray-300 text-left font-semibold align-middle" style="background-color: #${colorScheme.header};" rowspan="${task.count}">${task.name}</td>`;
                }
                for (let dayIndex = 0; dayIndex < 5; dayIndex++) { // Only loop through Mon-Fri
                     if (!scheduleDays[dayIndex].shouldSchedule) {
                        const dayInfo = scheduleDays[dayIndex];
                        const text = dayInfo.description || "休息";
                        const isHoliday = dayInfo.isHoliday;
                        
                        let bgColor = 'bg-gray-100';
                        let textColor = 'text-gray-400';

                        if(isHoliday) {
                            bgColor = 'bg-red-100';
                            textColor = 'text-red-700';
                        }
                        
                         if (i === 0) { 
                            tableBody += `<td class="p-2 border border-gray-300 ${bgColor} ${textColor} font-bold align-middle" rowspan="${task.count}">${text}</td>`;
                        }
                    } else {
                        const name = schedule[dayIndex][taskIndex][i];
                        const cellContent = name || '<span class="text-gray-500">(空)</span>';
                        const bgColor = name ? `style="background-color: #${colorScheme.name};"` : '';
                        tableBody += `<td class="p-2 border border-gray-300" ${bgColor}>${cellContent}</td>`;
                    }
                }
                tableBody += `</tr>`;
            }
        });
        tableBody += '</tbody>';
        
        table.innerHTML = tableHead + tableBody;
        return table;
    }

    function renderStatistics({ people, shiftCounts }, index) {
        let statsHTML = `<h3 class="text-lg font-bold mb-3 text-center">第 ${index + 1} 週個人班次統計</h3><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-8 gap-y-2">`;
        people.forEach(person => {
            const count = shiftCounts[person.name];
            const max = person.maxShifts;
            const isOver = count > max;
            const colorClass = isOver ? 'text-red-600 font-bold' : '';
            statsHTML += `<div class="flex justify-between ${colorClass}"><span>${person.name}:</span><span>${count} 次</span></div>`;
        });
        statsHTML += '</div>';
        return statsHTML;
    }

    async function downloadPDF() {
        const originalBtnText = downloadPdfBtn.textContent;
        downloadPdfBtn.textContent = 'PDF 產生中...';
        downloadPdfBtn.disabled = true;

        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            
            const printContainer = document.createElement('div');
            printContainer.style.position = 'absolute';
            printContainer.style.left = '-9999px';
            printContainer.style.top = '0';
            printContainer.style.width = '1000px'; 
            printContainer.style.padding = '20px';
            printContainer.style.fontFamily = "'標楷體', 'BiauKai', 'DFKai-SB', 'Noto Sans TC', sans-serif";
            printContainer.style.backgroundColor = '#ffffff';
            
            generatedData.forEach((data, index) => {
                const scheduleContainer = document.createElement('div');
                scheduleContainer.style.marginBottom = '20px';
                
                const weekTitle = document.createElement('h2');
                weekTitle.textContent = `第 ${index + 1} 週班表 (${data.dateRange})`;
                weekTitle.style.fontSize = '20px';
                weekTitle.style.fontWeight = 'bold';
                weekTitle.style.textAlign = 'center';
                weekTitle.style.marginBottom = '15px';
                scheduleContainer.appendChild(weekTitle);

                const tableElement = renderScheduleTable(data, data.colorScheme);
                tableElement.style.fontSize = '12px';
                 tableElement.querySelectorAll('th, td').forEach(cell => {
                    cell.style.padding = '5px';
                });
                scheduleContainer.appendChild(tableElement);
                printContainer.appendChild(scheduleContainer);
            });
            
            document.body.appendChild(printContainer);

            const canvas = await html2canvas(printContainer, { scale: 2, useCORS: true });
            document.body.removeChild(printContainer);

            const imgData = canvas.toDataURL('image/png');
            const A4_PAGE_HEIGHT = 297;
            const A4_PAGE_WIDTH = 210;
            const MARGIN = 15;
            const PDF_WIDTH = A4_PAGE_WIDTH - MARGIN * 2;
            const PDF_HEIGHT = A4_PAGE_HEIGHT - MARGIN * 2;
            const imgProps = pdf.getImageProperties(imgData);
            const aspectRatio = imgProps.width / imgProps.height;
            let finalImgHeight = PDF_WIDTH / aspectRatio;
            let finalImgWidth = PDF_WIDTH;
            if (finalImgHeight > PDF_HEIGHT) {
                finalImgHeight = PDF_HEIGHT;
                finalImgWidth = finalImgHeight * aspectRatio;
            }
            const xPos = (A4_PAGE_WIDTH - finalImgWidth) / 2;
            
            pdf.addImage(imgData, 'PNG', xPos, MARGIN, finalImgWidth, finalImgHeight);
            
            pdf.save('班表_多合一.pdf');

        } catch (error) {
            console.error("產生 PDF 時發生錯誤:", error);
            alert("抱歉，產生 PDF 時發生未預期的錯誤。");
        } finally {
            downloadPdfBtn.textContent = '下載 PDF';
            downloadPdfBtn.disabled = false;
        }
    }


    // --- Template Management ---
    function getTemplates() {
        return JSON.parse(localStorage.getItem(TEMPLATE_STORAGE_KEY) || '{"tasks":{},"names":{},"preferences":{},"unavailability":{}}');
    }

    function saveTemplate(type) {
        const textarea = document.getElementById(type);
        const content = textarea.value.trim();
        if (!content) {
            alert('內容是空的，無法儲存。');
            return;
        }
        const name = prompt('請為這個列表命名：');
        if (!name || !name.trim()) return;

        const templates = getTemplates();
        templates[type][name.trim()] = content;
        localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
        alert(`列表 "${name.trim()}" 已成功儲存！`);
    }

    function loadTemplate(type) {
        const templates = getTemplates();
        const specificTemplates = templates[type];
        const names = Object.keys(specificTemplates);

        if (names.length === 0) {
            alert('目前沒有任何已儲存的列表。');
            return;
        }

        modalBody.innerHTML = '';
        const list = document.createElement('ul');
        list.className = 'space-y-2';

        names.forEach(name => {
            const listItem = document.createElement('li');
            const loadButton = document.createElement('button');
            loadButton.textContent = name;
            loadButton.className = 'w-full text-left p-2 rounded-md hover:bg-gray-100';
            loadButton.onclick = () => {
                if (confirm(`確定要用 "${name}" 的內容覆蓋目前的輸入框嗎？`)) {
                    document.getElementById(type).value = specificTemplates[name];
                    closeModal();
                }
            };

            const deleteButton = document.createElement('button');
            deleteButton.textContent = '刪除';
            deleteButton.className = 'text-xs text-red-500 hover:text-red-700 ml-4 px-2';
            deleteButton.onclick = (e) => {
                e.stopPropagation();
                if (confirm(`確定要刪除 "${name}" 這個列表嗎？`)) {
                    delete templates[type][name];
                    localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
                    loadTemplate(type); // Refresh the list
                }
            };
            
            const itemContainer = document.createElement('div');
            itemContainer.className = 'flex justify-between items-center';
            itemContainer.appendChild(loadButton);
            itemContainer.appendChild(deleteButton);
            listItem.appendChild(itemContainer);
            list.appendChild(listItem);
        });

        modalBody.appendChild(list);
        modalTitle.textContent = `讀取 "${document.querySelector(`label[for='${type}']`).textContent}" 列表`;
        templateModal.style.display = 'flex';
    }
    
    function closeModal() {
        templateModal.style.display = 'none';
        exportModal.style.display = 'none';
    }
    
    modalCloseBtn.addEventListener('click', closeModal);
    
    document.querySelectorAll('.save-template-btn').forEach(btn => {
        btn.addEventListener('click', () => saveTemplate(btn.dataset.type));
    });

    document.querySelectorAll('.load-template-btn').forEach(btn => {
        btn.addEventListener('click', () => loadTemplate(btn.dataset.type));
    });

    // --- New Selective Export Logic ---
    function openExportModal() {
        exportModal.style.display = 'flex';
    }
    exportModalCloseBtn.addEventListener('click', closeModal);
    exportModalCancelBtn.addEventListener('click', closeModal);
    exportModalConfirmBtn.addEventListener('click', handleConfirmExport);

    async function handleConfirmExport() {
        const selectedProfileName = profileSelector.value;
        if (!selectedProfileName) {
            alert('請先選擇一個設定檔。');
            return;
        }

        const response = await fetch(`${API_BASE_URL}/api/data`);
        if (!response.ok) {
            alert('無法從伺服器取得設定檔資料，請稍後再試。');
            return;
        }
        const db = await response.json();
        const fullSettings = db.profiles[selectedProfileName]?.settings || {};
        const settingsToExport = {};

        if (document.getElementById('export-tasks').checked) settingsToExport.tasks = fullSettings.tasks;
        if (document.getElementById('export-names').checked) settingsToExport.names = fullSettings.names;
        if (document.getElementById('export-preferences').checked) settingsToExport.preferences = fullSettings.preferences;
        if (document.getElementById('export-unavailability').checked) settingsToExport.unavailability = fullSettings.unavailability;
        if (document.getElementById('export-maxShifts').checked) settingsToExport.defaultMaxShifts = fullSettings.defaultMaxShifts;
        if (document.getElementById('export-dates').checked) {
            settingsToExport.startDate = fullSettings.startDate;
            settingsToExport.numWeeks = fullSettings.numWeeks;
        }

        if (Object.keys(settingsToExport).length === 0) {
            alert('請至少選擇一個要匯出的項目。');
            return;
        }

        const blob = new Blob([JSON.stringify(settingsToExport, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${selectedProfileName}_partial_settings.json`;
        link.click();
        URL.revokeObjectURL(link.href);
        closeModal();
    }
    
    function importSettingsFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const settings = JSON.parse(e.target.result);
                
                if (settings.startDate !== undefined) allInputs.startDate.value = settings.startDate;
                if (settings.numWeeks !== undefined) allInputs.numWeeks.value = settings.numWeeks;
                if (settings.tasks !== undefined) allInputs.tasks.value = settings.tasks;
                if (settings.names !== undefined) allInputs.names.value = settings.names;
                if (settings.defaultMaxShifts !== undefined) allInputs.maxShifts.value = settings.defaultMaxShifts;
                if (settings.unavailability !== undefined) allInputs.unavailability.value = settings.unavailability;
                if (settings.preferences !== undefined) allInputs.preferences.value = settings.preferences;

                alert('設定已成功匯入至當前畫面！您可確認後再點擊「產生並儲存設定」來儲存變更。');

            } catch (error) {
                alert('匯入失敗：檔案格式不正確。');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    
    function exportToExcel() {
        if (!generatedData) return;
        const wb = XLSX.utils.book_new();
        generatedData.forEach((data, index) => {
            const { schedule, tasks, dateRange, colorScheme, weekDayDates, scheduleDays } = data;
            const sheetName = `第 ${index + 1} 週 (${dateRange})`.replace(/[/~]/g, '-');
            const weekDayNames = ['一', '二', '三', '四', '五'];
            const header = ["勤務地點", ...weekDayDates.slice(0, 5).map((date, i) => `星期${weekDayNames[i]}\n(${date})`)];
            const sheetData = [header];
            tasks.forEach((task, taskIndex) => {
                for (let i = 0; i < task.count; i++) {
                    const row = [ i === 0 ? task.name : null ];
                    for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                         if (!scheduleDays[dayIndex].shouldSchedule) {
                            row.push(i === 0 ? (scheduleDays[dayIndex].description || "休息") : null);
                        } else {
                            const names = schedule[dayIndex][taskIndex];
                            row.push(i < names.length ? names[i] : null);
                        }
                    }
                    sheetData.push(row);
                }
            });
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            const font = { name: '標楷體', color: { rgb: "000000" } };
            const thinBorder = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
            const headerStyle = { font: { ...font, bold: true }, fill: { fgColor: { rgb: colorScheme.header } }, border: thinBorder, alignment: { horizontal: "center", vertical: "center", wrapText: true } };
            const nameCellStyle = { font: font, fill: { fgColor: { rgb: colorScheme.name } }, border: thinBorder, alignment: { horizontal: "center", vertical: "center", wrapText: true } };
            const emptyCellStyle = { font: font, border: thinBorder, alignment: { horizontal: "center", vertical: "center", wrapText: true } };
            const holidayStyle = { font: { ...font, bold: true, color: { rgb: "b91c1c" } }, fill: { fgColor: { rgb: "fecaca" } }, border: thinBorder, alignment: { horizontal: "center", vertical: "center", wrapText: true } };
            
            if (!ws['!merges']) ws['!merges'] = [];
            let rowIndex = 1;
            tasks.forEach(task => {
                if (task.count > 1) ws['!merges'].push({ s: { r: rowIndex, c: 0 }, e: { r: rowIndex + task.count - 1, c: 0 } });
                rowIndex += task.count;
            });

            scheduleDays.slice(0, 5).forEach((day, dayIndex) => {
                if(!day.shouldSchedule){
                    let startRow = 1;
                    tasks.forEach(task => {
                        if(task.count > 0) {
                           ws['!merges'].push({ s: { r: startRow, c: dayIndex + 1 }, e: { r: startRow + task.count - 1, c: dayIndex + 1 } });
                           startRow += task.count;
                        }
                    });
                }
            });
            
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                    if (!ws[cell_ref]) ws[cell_ref] = { t: 's', v: null };

                    if (R === 0) {
                        ws[cell_ref].s = headerStyle;
                    } else if (C === 0) {
                        if (ws[cell_ref].v) ws[cell_ref].s = headerStyle;
                    } else {
                        const dayInfo = scheduleDays[C-1];
                        if (!dayInfo.shouldSchedule) {
                           ws[cell_ref].s = holidayStyle;
                        } else {
                            if (ws[cell_ref].v && ws[cell_ref].v !== '(空)') {
                               ws[cell_ref].s = nameCellStyle;
                            } else {
                               ws[cell_ref].s = emptyCellStyle;
                               if (!ws[cell_ref].v) ws[cell_ref].v = '(空)';
                            }
                        }
                    }
                }
            }
            
            ws['!cols'] = [{ wch: 20 }].concat(weekDayDates.slice(0, 5).map(() => ({ wch: 15 })));
            
            XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31));
        });

        XLSX.writeFile(wb, "班表.xlsx");
    }
    
    function copyToClipboard() {
        if (!generatedData) return;
        let tsvContent = '';
        generatedData.forEach((data, index) => {
            const { schedule, tasks, dateRange, weekDayDates, scheduleDays } = data;
            const weekDayNames = ['一', '二', '三', '四', '五'];
            tsvContent += `--- 第 ${index + 1} 週班表 (${dateRange}) ---\n`;
            tsvContent += ['勤務地點', ...weekDayDates.slice(0, 5).map((date, i) => `星期${weekDayNames[i]}(${date})`)].join('\t') + '\n';

            tasks.forEach((task, taskIndex) => {
                for (let i = 0; i < task.count; i++) {
                    const rowData = [ i === 0 ? task.name : '' ];
                    for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                         if (!scheduleDays[dayIndex].shouldSchedule) {
                            rowData.push(i === 0 ? (scheduleDays[dayIndex].description || "休息") : '');
                         } else {
                            const names = schedule[dayIndex][taskIndex];
                            rowData.push(i < names.length ? names[i] : '');
                         }
                    }
                    tsvContent += rowData.join('\t') + '\n';
                }
            });
            tsvContent += '\n';
        });
        navigator.clipboard.writeText(tsvContent).then(() => {
            copyBtn.textContent = '已複製！';
            setTimeout(() => { copyBtn.textContent = '複製 (純文字)'; }, 2000);
        }).catch(() => alert('複製失敗'));
    }

    });
    </script>
    </body>
    </html>

