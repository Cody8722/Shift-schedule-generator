# PDF 字體清晰度修復 - 測試步驟

> **修改日期**: 2025-11-12
> **Commit**: 254d9f4

## 問題描述

**原始問題**：PDF 匯出時字體模糊，因為多個員工被塞入單一儲存格，導致儲存格過高，瀏覽器縮小整頁。

**解決方案**：重構 HTML 生成邏輯，為每位員工生成一個獨立的 `<tr>`，使用 `rowspan` 讓任務名稱和假日跨越多列。

---

## ✅ 已修改的程式碼

### 檔案：`server.js`

**函數**：`generateScheduleHtml()` (lines 316-381)

**修改重點**：
- ❌ **之前**：`personnelNames.join('<br>')` - 多個員工用 `<br>` 塞入單一 `<td>`
- ✅ **現在**：每位員工佔據一個獨立的 `<tr>`，使用 `rowspan` 跨越列

**核心邏輯**：
```javascript
// 計算任務在整週中的最大員工數
const maxPersonnel = Math.max(...weekDayDates.map(...), 1);

// 為每位員工生成一個 <tr>
for (let personIndex = 0; personIndex < maxPersonnel; personIndex++) {
    taskRows += '<tr>';

    // 第一列使用 rowspan 顯示任務名稱和假日
    if (personIndex === 0) {
        taskRows += `<td rowspan="${maxPersonnel}">${escapeHtml(task.name)}</td>`;
    }

    // 每個儲存格只顯示一位員工
    const personName = personnel[personIndex] || '';
    taskRows += `<td>${escapeHtml(personName)}</td>`;

    taskRows += '</tr>';
}
```

---

## 🧪 測試步驟

### **步驟 1：停止並重啟伺服器**

**重要**：必須重啟伺服器才能載入新程式碼！

#### 選項 A：使用 `npm start`（手動重啟）
```bash
# 按 Ctrl+C 停止伺服器
# 然後重新啟動
npm start
```

#### 選項 B：使用 `npm run dev`（自動重啟）
```bash
# nodemon 會自動偵測檔案變更並重啟
npm run dev
```

**驗證伺服器已重啟**：
- 檢查終端機輸出，應該看到：`Server running on port 3000`
- 確認時間戳記是最新的

---

### **步驟 2：清除瀏覽器快取**

開啟無痕/私密瀏覽視窗，或清除快取：
- **Chrome**: Ctrl + Shift + Delete
- **Firefox**: Ctrl + Shift + Delete
- **Edge**: Ctrl + Shift + Delete

選擇「快取的圖片和檔案」→ 清除

---

### **步驟 3：生成測試班表**

1. 開啟瀏覽器，前往 `http://localhost:3000`
2. 設定勤務和人員：
   - **勤務**：早班（需要 3 人）、晚班（需要 2 人）
   - **人員**：至少 5-6 位員工

3. 生成班表：
   - 選擇開始週
   - 點擊「產生班表」
   - **確保某些任務在同一天有 2-3 位以上的員工**（這是測試重點）

---

### **步驟 4：檢查 HTML 預覽**

**在編輯模式下**：
- 班表會以標籤式顯示（這是正常的編輯模式）
- 每位員工是一個藍色標籤

**切換到預覽模式**：
- 點擊「👁️ 預覽模式」按鈕
- **這一步非常重要！** 預覽模式才會使用後端生成的正確 HTML

**檢查表格結構**：
- 開啟瀏覽器開發者工具（F12）
- 檢查 HTML 結構
- **正確的結構應該是**：
  ```html
  <!-- 早班任務，有 3 位員工 -->
  <tr>
    <td rowspan="3">早班</td>
    <td>員工A</td>
    <td>員工B</td>
    ...
  </tr>
  <tr>
    <!-- 沒有早班 td (被 rowspan 跨越) -->
    <td>員工C</td>
    <td>員工D</td>
    ...
  </tr>
  <tr>
    <!-- 沒有早班 td (被 rowspan 跨越) -->
    <td>員工E</td>
    <td>員工F</td>
    ...
  </tr>
  ```

**錯誤的結構**（如果看到這個，表示伺服器沒有更新）：
  ```html
  <tr>
    <td>早班</td>
    <td>員工A<br>員工B<br>員工C</td>
    ...
  </tr>
  ```

---

### **步驟 5：匯出 PDF 並檢查**

**在預覽模式下**（不是編輯模式！）：
1. 點擊「列印/匯出 PDF」按鈕
2. 使用瀏覽器的列印功能
3. 選擇「另存為 PDF」

**檢查 PDF 品質**：
- ✅ **字體應該清晰**，不模糊
- ✅ **每位員工佔據一列**，垂直擴展
- ✅ **任務名稱跨越多列**（使用 rowspan）
- ❌ **不應該**看到所有員工擠在同一個儲存格

---

### **步驟 6：比較測試結果**

**成功的 PDF**（像 10月班表.pdf）：
- 字體清晰
- 每位員工一列
- 表格垂直擴展，高度適中

**失敗的 PDF**（像 班表(8).pdf）：
- 字體模糊
- 多位員工擠在同一個儲存格
- 儲存格過高，整頁被縮小

---

## 🐛 故障排除

### 問題 1：仍然看到 `<br>` 或 `\n` 分隔的員工

**原因**：伺服器沒有重啟

**解決方案**：
```bash
# 完全停止伺服器
Ctrl + C

# 重新啟動
npm start
# 或
npm run dev
```

**驗證**：
- 檢查終端機啟動時間
- 檢查 server.js 的修改時間： `ls -l server.js`（Linux/Mac）或 `dir server.js`（Windows）

---

### 問題 2：預覽模式沒有變化

**原因**：前端快取或沒有切換到預覽模式

**解決方案**：
1. **確保在預覽模式下匯出 PDF**，不是編輯模式
2. 清除瀏覽器快取：Ctrl + Shift + Delete
3. 使用無痕視窗測試
4. 強制重新整理頁面：Ctrl + F5（Windows）或 Cmd + Shift + R（Mac）

---

### 問題 3：PDF 仍然模糊

**原因**：可能是 PDF 檢視器的縮放設定

**解決方案**：
1. 在 PDF 檢視器中設定縮放為 100%
2. 檢查 PDF 的實際解析度（應該是 JPEG 92% 品質）
3. 嘗試不同的 PDF 檢視器（Adobe Reader, Chrome, Firefox）

---

### 問題 4：表格結構看起來奇怪

**原因**：rowspan 可能在某些情況下沒有正確計算

**檢查**：
1. 開啟瀏覽器開發者工具（F12）
2. 檢查 `<td>` 元素是否有 `rowspan` 屬性
3. 檢查 rowspan 的值是否等於該任務的最大員工數

**報告 Bug**：
- 如果表格結構錯誤，請提供：
  - 班表的人員配置（每天每個任務有幾位員工）
  - HTML 原始碼（開發者工具中的 HTML）
  - 預期的結構 vs 實際的結構

---

## 📊 預期結果

### HTML 結構範例

**場景**：早班任務，週一 2 人（A, B），週二 3 人（C, D, E），週三假日，週四 1 人（F），週五 2 人（G, H）

**maxPersonnel** = max(2, 3, 0, 1, 2) = 3

**生成的 HTML**：
```html
<tbody>
  <!-- 第 1 列 (personIndex=0) -->
  <tr>
    <td rowspan="3">早班</td>  <!-- 任務名稱，跨 3 列 -->
    <td>A</td>                 <!-- 週一第 1 人 -->
    <td>C</td>                 <!-- 週二第 1 人 -->
    <td rowspan="3">假日</td>  <!-- 假日，跨 3 列 -->
    <td>F</td>                 <!-- 週四第 1 人 -->
    <td>G</td>                 <!-- 週五第 1 人 -->
  </tr>

  <!-- 第 2 列 (personIndex=1) -->
  <tr>
    <!-- 沒有任務 td (被 rowspan 跨越) -->
    <td>B</td>                 <!-- 週一第 2 人 -->
    <td>D</td>                 <!-- 週二第 2 人 -->
    <!-- 沒有假日 td (被 rowspan 跨越) -->
    <td></td>                  <!-- 週四第 2 人（空） -->
    <td>H</td>                 <!-- 週五第 2 人 -->
  </tr>

  <!-- 第 3 列 (personIndex=2) -->
  <tr>
    <!-- 沒有任務 td (被 rowspan 跨越) -->
    <td></td>                  <!-- 週一第 3 人（空） -->
    <td>E</td>                 <!-- 週二第 3 人 -->
    <!-- 沒有假日 td (被 rowspan 跨越) -->
    <td></td>                  <!-- 週四第 3 人（空） -->
    <td></td>                  <!-- 週五第 3 人（空） -->
  </tr>
</tbody>
```

**視覺效果**：
```
+------+---+---+----+---+---+
| 早班 | A | C | 假 | F | G |
+      +---+---+    +---+---+
|      | B | D | 日 |   | H |
+      +---+---+    +---+---+
|      |   | E |    |   |   |
+------+---+---+----+---+---+
```

---

## ✅ 成功標準

- [ ] 伺服器已重啟（檢查終端機時間戳記）
- [ ] 瀏覽器快取已清除（使用無痕視窗）
- [ ] 在**預覽模式**下匯出 PDF（不是編輯模式）
- [ ] HTML 結構使用 `rowspan`（檢查開發者工具）
- [ ] PDF 字體清晰，不模糊
- [ ] 每位員工佔據一列，表格垂直擴展

---

## 📝 測試報告模板

如果問題仍然存在，請提供以下資訊：

```
### 測試環境
- 作業系統：
- 瀏覽器：
- 伺服器啟動方式：npm start / npm run dev
- 伺服器啟動時間：

### 測試結果
- [ ] 伺服器已重啟
- [ ] 瀏覽器快取已清除
- [ ] 在預覽模式下匯出

### HTML 結構
（貼上開發者工具中看到的 HTML，特別是 <tbody> 部分）

### PDF 問題描述
（描述 PDF 中看到的問題，最好附上截圖）

### 預期 vs 實際
- 預期：每位員工一列
- 實際：（您看到的情況）
```

---

**最後更新**: 2025-11-12
