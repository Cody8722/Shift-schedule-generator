# 班表衝突檢測系統 - 前端整合說明

**版本**: Phase 2.1 完整版（後端 + 前端）
**實作日期**: 2025-11-12
**狀態**: ✅ 完成

---

## 📋 功能概述

前端整合實現了自動衝突檢測和視覺化顯示，讓使用者在生成班表時即時了解潛在問題。

### ✨ 核心功能

1. **自動驗證**: 生成班表後自動調用後端驗證 API
2. **衝突警告面板**: 清晰列出所有衝突並提供操作選項
3. **視覺化標記**: 衝突儲存格紅色高亮（脈動動畫）
4. **懸停提示**: 滑鼠懸停顯示衝突詳情
5. **快速操作**: 一鍵重新生成或關閉警告

---

## 🎨 使用者體驗

### 流程示意

```
1. 使用者點擊「產生智慧班表」
   ↓
2. 系統生成班表
   ↓
3. 🆕 自動驗證班表（呼叫 /api/schedules/validate）
   ↓
4. 如果有衝突 → 顯示警告面板 + 紅色標記儲存格
   如果無衝突 → 正常顯示班表
```

### 警告面板樣式

```
┌─────────────────────────────────────────────────┐
│ ⚠️ 發現 2 個班表衝突                             │
│                                                   │
│ • 員工A 在第 1 週 01/15 重複排班                 │
│ • 員工B 連續工作 6 天 (01/10 - 01/17)           │
│                                                   │
│ [ 🔄 重新生成 ]  [ ❌ 關閉警告 ]                │
└─────────────────────────────────────────────────┘
```

### 衝突儲存格視覺效果

- **顏色**: 紅色背景（淺紅 #fee2e2）
- **邊框**: 紅色加粗邊框（#ef4444）
- **動畫**: 2秒脈動效果
- **游標**: 問號提示游標（cursor: help）
- **工具提示**: 懸停顯示衝突原因

---

## 💻 技術實作

### 檔案位置

**index.html**:
- JavaScript: 行 743-909（新增約 166 行程式碼）
- CSS: 行 126-146（新增約 20 行樣式）

### 新增函數

| 函數名稱 | 功能 | 行數 |
|---------|------|------|
| `validateScheduleAndDisplay()` | 調用驗證 API 並處理結果 | 746-768 |
| `displayConflictWarning()` | 創建並顯示警告面板 | 770-845 |
| `clearConflictWarning()` | 移除警告面板和標記 | 847-856 |
| `highlightConflictCells()` | 標記衝突儲存格 | 858-867 |
| `highlightDuplicateConflict()` | 標記重複排班 | 869-883 |
| `highlightOverworkConflict()` | 標記過勞 | 885-896 |
| `formatDate()` | 格式化日期顯示 | 898-903 |
| `regenerateSchedule()` | 重新生成班表 | 905-908 |

### 全局變數

```javascript
let validationResult = null;  // 儲存驗證結果
```

---

## 🎯 衝突類型顯示

### 1. 重複排班（duplicate）

**顯示訊息**:
```
員工A 在第 1 週 01/15 重複排班
```

**視覺標記**:
- 找到該週對應日期的所有包含該員工的儲存格
- 全部標記為紅色
- 工具提示: "⚠️ 員工A 在此日重複排班"

---

### 2. 過勞（overwork）

**顯示訊息**:
```
員工B 連續工作 6 天 (01/10 - 01/17)
```

**視覺標記**:
- 標記該員工所有連續工作日的儲存格
- 全部標記為紅色
- 工具提示: "⚠️ 員工B 連續工作 6 天"

---

## 🔧 CSS 樣式

### 衝突儲存格樣式

```css
.conflict-cell {
    background-color: #fee2e2 !important;
    border: 2px solid #ef4444 !important;
    animation: pulse-red 2s ease-in-out infinite;
    cursor: help;
}

.dark .conflict-cell {
    background-color: #7f1d1d !important;
    border-color: #dc2626 !important;
}
```

### 脈動動畫

```css
@keyframes pulse-red {
    0%, 100% { background-color: #fee2e2; }
    50% { background-color: #fecaca; }
}
```

**效果**: 2秒週期，從淺紅到較深紅之間脈動

---

## 🚀 使用者操作

### 操作 1: 重新生成班表

**觸發**:
- 點擊警告面板中的「🔄 重新生成」按鈕

**行為**:
1. 關閉警告面板
2. 清除衝突標記
3. 自動重新調用生成班表函數
4. 重新驗證新生成的班表

**適用場景**:
- 使用者希望系統再次嘗試生成無衝突的班表

---

### 操作 2: 關閉警告

**觸發**:
- 點擊警告面板中的「❌ 關閉警告」按鈕

**行為**:
1. 移除警告面板
2. 清除所有衝突標記
3. 班表保持當前狀態

**適用場景**:
- 使用者已了解衝突並選擇忽略
- 使用者想要手動編輯班表來解決衝突

---

### 操作 3: 懸停查看詳情

**觸發**:
- 滑鼠懸停在紅色標記的儲存格上

**行為**:
- 顯示工具提示（tooltip）
- 說明該儲存格為何被標記為衝突

**範例**:
- "⚠️ 員工A 在此日重複排班"
- "⚠️ 員工B 連續工作 6 天"

---

## 📱 響應式設計

### 桌面版

- 警告面板完整顯示
- 衝突列表清晰可讀
- 按鈕並排顯示

### 手機版

- 警告面板自動適應寬度
- 文字自動換行
- 按鈕堆疊顯示（flex-wrap）

---

## 🌙 深色模式支援

### 警告面板

- 自動適應深色模式
- 背景色: `bg-red-50` → 深色模式自動調整

### 衝突儲存格

```css
.dark .conflict-cell {
    background-color: #7f1d1d !important;  /* 深紅色 */
    border-color: #dc2626 !important;       /* 紅色邊框 */
}
```

### 脈動動畫

```css
.dark @keyframes pulse-red {
    0%, 100% { background-color: #7f1d1d; }
    50% { background-color: #991b1b; }
}
```

---

## 🔄 自動重新驗證場景

### 場景 1: 初次生成班表

```javascript
generateFullSchedule()
  → API: POST /api/generate-schedule
  → displaySchedule(html)
  → validateScheduleAndDisplay()  // 自動觸發
  → 顯示衝突（如果有）
```

### 場景 2: 點擊「重新生成」

```javascript
regenerateSchedule()
  → clearConflictWarning()
  → generateFullSchedule()
  → validateScheduleAndDisplay()  // 自動觸發
  → 顯示衝突（如果有）
```

### 場景 3: 變更設定後自動更新

```javascript
handleSettingsChange()
  → generateFullSchedule()
  → validateScheduleAndDisplay()  // 自動觸發
  → 顯示衝突（如果有）
```

---

## ⚙️ 配置選項

### 驗證限制條件

目前硬編碼在前端：

```javascript
constraints: {
    maxConsecutiveDays: 5,  // 最大連續工作天數
    minRestDays: 2          // 最小休息天數（未來實作）
}
```

### 未來擴展

可以將限制條件移至：
1. **使用者設定**: 允許使用者自訂限制
2. **Profile 設定**: 不同 Profile 有不同的限制條件
3. **全局配置**: 在設定頁面中統一配置

---

## 🐛 已知限制

### 1. 編輯模式下的標記

**問題**: 在可編輯模式下，衝突標記可能不準確

**原因**:
- 編輯模式使用不同的 DOM 結構（標籤式顯示）
- 標記邏輯針對 HTML 表格模式設計

**解決方案**（未來）:
- 在編輯模式下也實作衝突標記
- 使用不同的標記策略（標籤顏色、圖示）

---

### 2. 即時驗證

**目前狀態**: 只在生成班表時驗證

**未來改進**:
- 在編輯模式下拖拉人員時即時驗證
- 動態更新衝突標記
- 提供預測性警告

---

### 3. 衝突定位精度

**問題**: 過勞標記可能標記整個人員的所有儲存格

**原因**:
- 後端返回的衝突資訊包含所有日期
- 前端遍歷所有儲存格尋找匹配

**改進空間**:
- 更精確的儲存格定位演算法
- 使用 data 屬性標記儲存格的日期和人員

---

## 📊 效能考量

### API 調用時機

- **觸發**: 每次生成班表後
- **頻率**: 低（使用者主動觸發）
- **延遲**: ~50-100ms（典型班表）

### DOM 操作

- **警告面板**: 一次性插入，使用 innerHTML
- **儲存格標記**: 遍歷所有 td 元素（O(n)）
- **清除標記**: querySelectorAll + classList.remove

### 優化建議

1. **延遲驗證**: 使用 debounce 避免頻繁調用
2. **快取結果**: 相同班表數據不重複驗證
3. **增量標記**: 只標記變更的儲存格

---

## 🧪 測試清單

### 功能測試

- [ ] 生成無衝突班表 → 不顯示警告
- [ ] 生成有重複排班的班表 → 顯示警告 + 紅色標記
- [ ] 生成有過勞的班表 → 顯示警告 + 紅色標記
- [ ] 點擊「重新生成」→ 警告消失 + 重新生成
- [ ] 點擊「關閉警告」→ 警告消失 + 標記清除
- [ ] 懸停衝突儲存格 → 顯示工具提示

### UI 測試

- [ ] 警告面板樣式正確（紅色背景、邊框）
- [ ] 衝突儲存格紅色高亮
- [ ] 脈動動畫正常播放
- [ ] 深色模式下顏色正確
- [ ] 手機版響應式佈局正常

### 整合測試

- [ ] 驗證 API 正確調用
- [ ] 錯誤處理（API 失敗時）
- [ ] 多週班表的衝突標記
- [ ] 編輯模式切換後標記保持

---

## 🔜 未來擴展（Phase 2.2+）

### 即時驗證

- 在編輯模式下拖拉人員時即時檢查衝突
- 提供預測性警告（"如果你移動此人員，將產生衝突"）

### 智能建議

- 分析衝突原因
- 提供解決建議（"建議將員工A的週三班次移至員工B"）
- 一鍵應用建議

### 衝突統計

- 顯示衝突趨勢圖表
- 追蹤歷史衝突率
- 按類型分組統計

### 自訂規則

- 允許使用者定義自訂衝突規則
- 靈活的限制條件配置
- 規則優先級設定

---

## 📞 故障排除

### 問題 1: 警告面板不顯示

**可能原因**:
- API 驗證失敗（檢查瀏覽器 Console）
- 班表數據格式錯誤

**檢查步驟**:
1. 開啟瀏覽器開發者工具
2. 查看 Network 標籤，確認 API 調用
3. 查看 Console 標籤，檢查錯誤訊息

---

### 問題 2: 衝突標記不顯示

**可能原因**:
- CSS 樣式未載入
- 儲存格定位邏輯錯誤

**檢查步驟**:
1. 檢查元素是否有 `.conflict-cell` class
2. 檢查 CSS 是否正確載入
3. 檢查 `schedule-week-${index}` ID 是否正確

---

### 問題 3: 按鈕點擊無反應

**可能原因**:
- 事件監聽器未綁定
- 函數作用域問題

**檢查步驟**:
1. 檢查 Console 是否有錯誤
2. 確認按鈕 ID 正確（`regenerate-btn`, `dismiss-warning-btn`）
3. 檢查函數是否在正確作用域

---

## 📝 使用範例

### 範例 1: 正常流程

```
1. 使用者設定：3 個任務，5 個員工
2. 點擊「產生智慧班表」
3. 系統生成班表（2 週）
4. 自動驗證 ✅ 無衝突
5. 顯示班表，無警告面板
```

### 範例 2: 發現衝突

```
1. 使用者設定：2 個任務（早班、晚班），3 個員工
2. 點擊「產生智慧班表」
3. 系統生成班表（2 週）
4. 自動驗證 ❌ 發現衝突：
   - 員工A 在週一同時排早班和晚班
5. 顯示紅色警告面板
6. 員工A 的週一儲存格標記為紅色（脈動）
7. 使用者懸停查看詳情
8. 點擊「重新生成」
9. 系統重新生成新班表
10. 新班表無衝突 ✅
```

---

**文件版本**: 1.0.0
**最後更新**: 2025-11-12
**實作 Commit**: 待提交
